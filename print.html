<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The SubstraTEE Book</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="introduction.html">Introduction</a></li><li class="expanded "><a href="trusted_execution.html"><strong aria-hidden="true">1.</strong> What is Trusted Execution?</a></li><li><ol class="section"><li class="expanded "><a href="remote_attestation.html"><strong aria-hidden="true">1.1.</strong> Remote Attestation</a></li></ol></li><li class="expanded "><a href="what_for.html"><strong aria-hidden="true">2.</strong> What is SubstraTEE Good For?</a></li><li><ol class="section"><li class="expanded "><a href="privacy.html"><strong aria-hidden="true">2.1.</strong> Privacy</a></li><li class="expanded "><a href="scalability.html"><strong aria-hidden="true">2.2.</strong> Scalability</a></li><li class="expanded "><a href="interoperability.html"><strong aria-hidden="true">2.3.</strong> Interoperability</a></li><li class="expanded "><a href="use_case_cdn.html"><strong aria-hidden="true">2.4.</strong> CDN</a></li></ol></li><li class="expanded "><a href="design.html"><strong aria-hidden="true">3.</strong> Design</a></li><li><ol class="section"><li class="expanded "><a href="security.html"><strong aria-hidden="true">3.1.</strong> Security</a></li><li class="expanded "><a href="benchmarks.html"><strong aria-hidden="true">3.2.</strong> Benchmarks</a></li></ol></li><li class="expanded "><a href="guides.html"><strong aria-hidden="true">4.</strong> Howto</a></li><li><ol class="section"><li class="expanded "><a href="howto_node.html"><strong aria-hidden="true">4.1.</strong> How To Run a Node</a></li><li class="expanded "><a href="howto_worker.html"><strong aria-hidden="true">4.2.</strong> How To Run a Worker</a></li><li class="expanded "><a href="howto_private_tx.html"><strong aria-hidden="true">4.3.</strong> How To Perform a Private Transaction</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The SubstraTEE Book</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><img src="./fig/substraTEE-logo-scs.svg" alt="logo" /></p>
<p><img src="./fig/web3_foundation_grants_badge_black.svg" alt="web3grant" /></p>
<h1><a class="header" href="#remote-attestation" id="remote-attestation">Remote Attestation</a></h1>
<p><em>TODO</em> </p>
<p>The goal of attestation is to convince a third party that a specific piece of code is running on a genuine Intel SGX HW.</p>
<h2><a class="header" href="#convincing-the-substratee-user" id="convincing-the-substratee-user">convincing the substraTEE user</a></h2>
<p>A user that interacts with substraTEE wants to be sure that the shielding pubkey she uses to encrypt her call to the STF originates form an enclave that</p>
<ol>
<li>is running on genuine Intel SGX HW</li>
<li>runs the official code</li>
<li>accesses the correct STF state</li>
</ol>
<h3><a class="header" href="#classical-remote-attestation-solution" id="classical-remote-attestation-solution">Classical Remote Attestation Solution</a></h3>
<p>The standard use case for remote attestation involves a service provider (SP) like a video streaming service which wants to be sure his viewer application runs on a genuine SGX HW and respects DRM.
The SP therefore requests a quote from the application and sends that quote to Intel Attestation Services (IAS) who sign off the quote if it is genuine.</p>
<p>The issue here is that IAS only talks to registered clients. You need to register in order to get a SPID which needs to be supplied along with requests.</p>
<h3><a class="header" href="#attestation-registry-on-chain" id="attestation-registry-on-chain">Attestation Registry On-Chain</a></h3>
<p>It isn't practical to ask every client to register with Intel and perform RA before every request. Therefore we'd rather let the substraTEE-worker operators attest their enclaves with IAS and write the signed quote and their certificate to the blockchain for everyone to verify.</p>
<p>This does change the the attestation protocol. Now the SP and the enclave in the above scheme are both running on the same machine. substraTEE-worker will itself perform an attestation protocol with its enclave and get the quote signed by IAS. Like this, only substraTEE operators need to register with IAS.</p>
<p><img src="./attestation_registry_sequence.svg" alt="Sequence Diagram" /></p>
<p>The attestation report which is written to an on-chain registry contains:</p>
<ul>
<li>enclave quote
<ul>
<li>report body
<ul>
<li>MRENCLAVE (hash of enclave build)</li>
<li>Product ID (hard-coded in substraTEE source)</li>
<li>Security Version (hard-coded in substraTEE source)</li>
<li>user data is hash of context:
<ul>
<li>enclave-individual signing pubkey</li>
<li>latest block hash</li>
</ul>
</li>
</ul>
</li>
<li>...</li>
</ul>
</li>
<li>IAS response
<ul>
<li>body
<ul>
<li>status (OK||CONFIGURATION_NEEDED|GROUP_REVOKED....)</li>
<li>timestamp</li>
<li>enclave quote</li>
<li>...</li>
</ul>
</li>
<li>IAS certificate </li>
<li>IAS signature over above body</li>
</ul>
</li>
</ul>
<p>Any user can now verify IAS signature and MRENCLAVE (given the substraTEE enclave can be built deterministically). See the <a href="https://github.com/rodolfoams/sgx-retrieve-identity/blob/5be913b96b2a6e5a0e1158ad169b977507291faa/Makefile#L253">example</a> how you can extract MRENCLAVE after building the enclave</p>
<p>The worker can now publish his sealing pubkey, signed with its enclave-individual signing key stated in the quote.</p>
<p>workers will repeat remote attestation in reasonable regular intervals (i.e. once per month)</p>
<h3><a class="header" href="#enclave-registry-on-chain" id="enclave-registry-on-chain">Enclave Registry On-Chain</a></h3>
<p>In order for the chain validator to be able to verify MRENCLAVE, there must be a consensus about MRENCLAVE of the valid version of substraTEE.</p>
<p>substraTEE developers will propose code updates to be voted on. Validators check the code and 
vote on behalf or against each proposal. MRENCLAVE can be reproduced by cloning the substraTEE-worker repo, building it and then:</p>
<pre><code>sgx_sign dump -enclave enclave.signed.so -dumpfile out.log
</code></pre>
<p>TODO: we might need to provide a docker environment the achieve deterministic builds.</p>
<h2><a class="header" href="#secret-provisioning" id="secret-provisioning">secret provisioning</a></h2>
<p>In order to establish shared secrets among workers, they need to convince themselves mutually that they are genuine before entering some <em>Distributed Key Generation</em> (DKG) protocol.</p>
<h2><a class="header" href="#sealing" id="sealing">Sealing</a></h2>
<p>provisioned secrets are sealed with Intel's <a href="https://software.intel.com/en-us/blogs/2016/05/04/introduction-to-intel-sgx-sealing">SGX Sealing</a>. Two different kinds of sealing exist. MRENCLAVE is unique for each build and each piece of HW. MRSIGNER is based on the authority of a SW vendor. The latter is practical for proprietary software because vendors can update their SW without re-provisioning secrets.</p>
<p>However, for decentralized open source projects, MRSIGNER cannot apply as there is no authority that could sign builds.</p>
<p>Therefore, <em>enclave identity</em> MRSIGNER must be applied.</p>
<h3><a class="header" href="#sw-updates" id="sw-updates">SW updates</a></h3>
<p>As SW updates will have a different measurement, the new build can't read the state that was encrypted by the old build. Local attestation allows the new version to request the provisioned secrets. </p>
<p>We assume reproducible builds for enclaves which should be possible with Rust subject to  some assumptions. For now, watch <a href="https://github.com/rust-lang/rust/issues/34902">this issue</a> and <a href="https://github.com/rust-secure-code/cargo-repro">cargo-repro</a>.</p>
<p>Simplified Protocol</p>
<ol>
<li>new version's TCB hash gets voted for by onchain consensus</li>
<li>new version registers its attestation on-chain</li>
<li>old version shares provisioned secret with new version running on same machine by means of local (intra-platform) attestation if new version's tcb corresponds to onchain registry</li>
</ol>
<p>See <a href="https://software.intel.com/en-us/articles/innovative-technology-for-cpu-based-attestation-and-sealing">Intel's sealing paper</a></p>
<h2><a class="header" href="#ias" id="ias">IAS</a></h2>
<p>Intel <a href="https://software.intel.com/en-us/blogs/2016/01/07/intel-sgx-debug-production-prelease-whats-the-difference">defines different modes</a> for running enclaves.</p>
<p>compilation modes: <em>Debug</em>, <em>Release</em>, <em>Pre-Release</em>, <em>Simulation</em>
lanching modes: <em>Debug</em>, <em>Production</em></p>
<h3><a class="header" href="#epid" id="epid">EPID</a></h3>
<p>Enhanced Privacy ID (EPID). A group signature key known only to the quoting enclave. Only used for remote attestation.</p>
<h3><a class="header" href="#spid" id="spid">SPID</a></h3>
<p>A Service Provider ID (SPID) is needed to talk to IAS. Developers can obtain their SPID by <a href="https://software.intel.com/en-us/form/sgx-onboarding">registering with Intel</a> (only allows to attest DEBUG encalves!)</p>
<p>You can request either <em>linkable</em> or <em>unlinkable</em> quote. </p>
<p><strong>tl;dr</strong>: selecting UNLINKABLE is a safe choice. But don't expect to be anonymous.</p>
<p>In both cases, the quoting enclave uses a group signature for a quote. You can just decide if you wish two subsequent signatures to be linkable (an observer learns &quot;quote was signed by same platform&quot;) or not.</p>
<p>In any case, Intel can identify YOU by SSID as you use your SSID for remote attestation with IAS. It just doesn't learn about which HW platform the quote originates from.</p>
<h3><a class="header" href="#production-vs-debug-mode" id="production-vs-debug-mode">Production vs. Debug Mode</a></h3>
<p>Due to Intel policy, developers can only compile enclaves in <em>Debug</em>, <em>Pre-Release</em> or <em>Simulation</em> mode. This means that the enclave will always be launched in <em>Debug</em> mode which doesn't provide confidentiality as enclave memory isn't encrypted.</p>
<p>In order to compile enclaves in <em>Release</em> mode (and run them in <em>Production</em> mode), the SW vendor has to apply for a SGX production license. 
Moreover, remote attestation in production mode can only be taken out with such production license.</p>
<p><em>SCS is looking into options how to apply such policy to a decentralized system with Intel.</em></p>
<p><strong>solution candidate</strong></p>
<ol>
<li>A set of <em>companies</em> (i.e. SCS, web3 foundation) register a production license with Intel</li>
<li>substraTEE-workers send their RA quotes to the chain.</li>
<li>the <em>company</em> listens to new RA quotes and sends them to IAS with the <em>company's</em> SPID.</li>
<li>the <em>company</em> sends the IAS report to the chain.</li>
</ol>
<h2><a class="header" href="#literature" id="literature">Literature</a></h2>
<p>chaotic list of pointers:</p>
<ul>
<li><a href="https://davejingtian.org/2017/11/10/some-notes-on-the-monotonic-counter-in-intel-sgx-and-me/">review of SGX PSE for monotonic counters and trusted time</a></li>
</ul>
<h1><a class="header" href="#what-to-use-tees-for" id="what-to-use-tees-for">What to use TEEs for</a></h1>
<p><em>TODO</em></p>
<p>documentation for substraTEE, an extension of <a href="https://github.com/paritytech/substrate">parity substrate</a> allowing to leverage Trusted Execution Environments (TEEs) to provide integrity and confidentiality</p>
<h1><a class="header" href="#different-ways-to-leverage-tees" id="different-ways-to-leverage-tees">Different ways to leverage TEEs</a></h1>
<table><thead><tr><th>use case</th><th>substraTEE-signer <br>(off-chain stateless)</th><th>substraTEE-worker<br> (off-chain stateful)</th><th>substraTEE-node<br> (onchain-stateful)</th></tr></thead><tbody>
<tr><td>hardware wallet</td><td>:+1: local TEE per user</td><td></td><td>:thumbsdown:</td></tr>
<tr><td>atomic swaps<br>(cross-chain bridge)</td><td>:+1: light node in both chains</td><td>:+1:</td><td>:thumbsdown:</td></tr>
<tr><td>coinmixer</td><td>:+1:</td><td>:thumbsdown:</td><td>:thumbsdown:</td></tr>
<tr><td>oracle</td><td>:+1:</td><td>:+1:</td><td>difficult if non-deterministic</td></tr>
<tr><td>inheritance notary</td><td>:+1:</td><td>:+1:</td><td>storage expensive</td></tr>
<tr><td>confidential transactions</td><td>:thumbsdown:</td><td>:thumbsdown: doesn't scale? (collisions of state changes)</td><td>:+1: <a href="https://encointer.org">encointer</a></td></tr>
<tr><td>2nd layer confidential payment hub (Similar to <a href="https://github.com/lsds/Teechain">TeeChan</a>)</td><td></td><td>:+1:</td><td></td></tr>
<tr><td>confidential smart contracts</td><td>:thumbsdown:</td><td>:+1: (Ekiden, PDO, <a href="https://encointer.org">encointer</a>)</td><td>computation time and storage expensive</td></tr>
<tr><td><a href="https://sawtooth.hyperledger.org/docs/core/releases/1.0/architecture/poet.html">POET</a> consensus</td><td>:thumbsdown:</td><td>:thumbsdown:</td><td>:thumbsdown:</td></tr>
</tbody></table>
<h1><a class="header" href="#substratee-signer" id="substratee-signer">substraTEE-signer</a></h1>
<p><em>off-chain</em>: nothing special needs to be run by blockchain validators. normal transactions</p>
<p><em>stateless</em>: no state needs to be preserved (onchain - data or hash) between uses</p>
<p><img src="./substraTEE-signer.svg" alt="signer" /></p>
<p>One flavour of substraTEE is a RPC client for substrate that runs a state transition function (STF) within a TEE (Intel SGX). </p>
<p>Main feature: trusted hardware custodian of your private keys</p>
<h1><a class="header" href="#substratee-worker" id="substratee-worker">substraTEE worker</a></h1>
<p><em>off-chain</em>: nothing special needs to be run by blockchain validators. normal transactions</p>
<p><em>stateful</em>: state needs to be preserved (onchain - data or hash) between uses</p>
<p><img src="./substraTEE-offchain-contract.svg" alt="offchain-contract" /></p>
<p>Similar to but still quite different than <a href="https://github.com/hyperledger-labs/private-data-objects">sawtooth PDO</a> or <a href="https://www.oasislabs.com/">Ekiden/OasisLabs</a></p>
<p><em>Do not confuse substraTEE-worker with substrate's <a href="https://github.com/paritytech/substrate/pull/1942">off-chain workers</a>. The latter are a part of the node's codebase. SubstraTEE worker is a standalone service interfacing substrate node using RPC or websockets</em> </p>
<p>Dapps can commit WASM contracts and run their own TEE's or hire an enclave service to run confidential WASM smart contracts on. delegates are remote attested on the blockchain (the TCB doesn't include the WASM contract). They have to be fed with the most recent state, call and opaque payload. They then update the state that is written back to the chain.</p>
<h1><a class="header" href="#substratee-stealth-node" id="substratee-stealth-node">substraTEE-stealth-node</a></h1>
<p><em>on-chain</em>: blockchain validators run confidential state transition function with every extrinsic. </p>
<p><em>stateful</em>: state needs to be preserved (onchain - data or hash) between uses</p>
<p>a fork of substrate that has an Executor running in a TEE (Intel SGX)</p>
<p>Main feature: many confidential transactions can be executed with every block</p>
<p><img src="./substraTEE-stealth-node.svg" alt="node" /></p>
<h1><a class="header" href="#interoperability" id="interoperability">Interoperability</a></h1>
<h1><a class="header" href="#use-case-cdn-subscriptions" id="use-case-cdn-subscriptions">Use Case CDN Subscriptions</a></h1>
<p>SubstraTEE could be used to restrict (narrow- or broadband) content delivery to paying users. Examples could be blogs, articles, video streaming, video on-demand, music streaming or on-deman aso.</p>
<h2><a class="header" href="#basic-substratee-application-for-cdn" id="basic-substratee-application-for-cdn">Basic SubstraTEE application for CDN</a></h2>
<ul>
<li>Subscriptions are managed on-chain, as are payments (can be flat subscription fees or pay-per-use)</li>
<li>SubstraTEE-worker holds the content-encryption key pair (CEK). Only the worker enclave(s) can read this RSA private key. 
No consumers or publishers nor operators have access</li>
<li>publishers commit their content (encrypted with the CEK (RSA+AES)) to IPFS and register the content on-chain, providing the IPFS url</li>
<li>consumers request content from the substraTEE-worker over a TLS channel (can be https, wss, json-rpc, REST), which 
<ul>
<li>authenticates the consumer and looks up subscription status on-chain</li>
<li>fetches the requested content from IPFS</li>
<li>decrypts the content</li>
<li>sends the content to the consumer over the previously established TLS channel</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#cek-turnover" id="cek-turnover">CEK turnover</a></h2>
<p>As a first implementation, the CEK can stay constant over time. However, we should be able to rotate this key if we need to revoke.</p>
<h2><a class="header" href="#access-to-archive-prior-to-subscription" id="access-to-archive-prior-to-subscription">Access to Archive Prior to Subscription</a></h2>
<p>Because the private CEK is known to all worker enclaves and never needs to be known to publishers or subscribers we do not need to trans-encrypt content. 
It doesn't matter at what time a consumer subscribes. The worker can deliver all prior content to the subscriber. 
The subscription metadata can include restrictions to archive access. </p>
<h2><a class="header" href="#pay-per-use" id="pay-per-use">Pay per use</a></h2>
<p>Pay per use bears the risks of leaking private information. We'd suggest to maintain subscription balances within the worker enclave, not onchain. This way, the public doesn't learn detailed usage patterns. See our <a href="./M5_DEMO.html">private-tx example</a> for how this could work.</p>
<h1><a class="header" href="#substratee-security" id="substratee-security">SubstraTEE Security</a></h1>
<p>The following is an overview of security aspects of substraTEE, mainly focusing on Intel SGX properties. It is neither complete nor guaranteed to be accurate. It just reflects the best of our knowledge ATM.</p>
<h2><a class="header" href="#exploitable-properties-of-sgx" id="exploitable-properties-of-sgx">exploitable properties of SGX</a></h2>
<ul>
<li>An enclave has no way to control how many instances of that enclave are instantiated.</li>
<li>An enclave process can be interrupted at any point. </li>
<li>monotonic counter and trusted time provided by Platform Services (PSE) rely on Intel ME, which <a href="https://en.wikipedia.org/wiki/Intel_Management_Engine#Security_vulnerabilities">doesn't have a good reputation for security</a>.</li>
</ul>
<p>See: <a href="https://youtu.be/0ZxBO3vLB-A">black hat presentation by Swami</a></p>
<h2><a class="header" href="#attacks" id="attacks">Attacks</a></h2>
<h3><a class="header" href="#rollbackreplay-attack" id="rollbackreplay-attack">Rollback/Replay Attack</a></h3>
<p>An enclave has no way to verify that it is operating on the latest state (i.e. read from a sealed file on disk).</p>
<p>It cannot be assured that calls to the enclave happen sequentially. They can happen in parallel, possibly leaking secrets i.e. because a secret with weak randomness is encrypted many times with the same nonce, weakening the confidentiality.</p>
<p><strong>Countermeasures</strong></p>
<ul>
<li>monotonic counter (i.e. Intel PSE, based on ME. Not available on server HW). If you choose to trust Intel ME!</li>
<li>Blockchain registers the hash of the latest state, so a state update is only valid when it refers to the latest registered state. This doesn't solve the cause, but the symptoms.</li>
</ul>
<h3><a class="header" href="#global-state-malleability" id="global-state-malleability">Global State Malleability</a></h3>
<p>An enclave ecall can be interrupted at any time by interrupts. Instead of returning after the interrupt, an attacker can then call the same ecall again.</p>
<p><strong>Countermeasures</strong></p>
<ul>
<li>verify-first-write-last: not only for sealed storage, but also for global state variables.</li>
</ul>
<h3><a class="header" href="#reentrancy-attack--global-state-malleability" id="reentrancy-attack--global-state-malleability">Reentrancy Attack / Global state Malleability</a></h3>
<p>Can be a special case of the <em>Rollback Attack</em>.
Similar to smart contracts reentrancy.</p>
<p><a href="https://medium.com/@gus_tavo_guim/reentrancy-attack-on-smart-contracts-how-to-identify-the-exploitable-and-an-example-of-an-attack-4470a2d8dfe4">Explanation of reentrancy attack for smart contracts</a></p>
<p><strong>Countermeasures</strong></p>
<ul>
<li>verify-first-write-last </li>
</ul>
<h3><a class="header" href="#simulator-attacks" id="simulator-attacks">Simulator Attacks</a></h3>
<p>Some emulator pretends to be an enclave.</p>
<p><strong>Countermeasure</strong></p>
<ul>
<li>Remote Attestation with IAS</li>
</ul>
<h3><a class="header" href="#man-in-the-middle-attack" id="man-in-the-middle-attack">Man-In-The-Middle Attack</a></h3>
<p>Intel could attack a service provider by always replying to RA requests positively and put a simulated enclave as a MITM.
(Intel knows, which SP is requesting a RA as it knows the SPID)</p>
<p><strong>Countermeasure</strong></p>
<p>none.</p>
<p>See <a href="https://youtu.be/0ZxBO3vLB-A">black hat presentation by Swami</a> at 34:50</p>
<h3><a class="header" href="#foreshadow" id="foreshadow">Foreshadow</a></h3>
<p>This side-channel attack compromised both integrity and confidentiality (and therefore Remote Attestation as well). It has been fixed in Intel's recent microcode.</p>
<p><a href="https://en.wikipedia.org/wiki/Foreshadow_(security_vulnerability)">Foreshadow</a></p>
<p><strong>Countermeasures</strong></p>
<ul>
<li>update your SGX HW</li>
<li>verify SGX is up-to-date for all substraTEE-workers (IAS tells us with their remote attestation report)</li>
</ul>
<h1><a class="header" href="#benchmark" id="benchmark">Benchmark</a></h1>
<p><em>TODO</em> </p>
<table><thead><tr><th>ops</th><th>call_counter_wasm</th><th>call_counter</th><th>no compose_extrinsic</th><th>msg decryption</th><th>counter update</th><th>sgx_file_read</th><th>counter update + no_ops ocall</th></tr></thead><tbody>
<tr><td>ecall</td><td>☑</td><td>☑</td><td>☑</td><td>☑</td><td>☑</td><td>☑</td><td>☑</td></tr>
<tr><td>sgx::fs::read (rsa key)</td><td>☑</td><td>☑</td><td>☑</td><td>☑</td><td></td><td>☑</td><td>☑</td></tr>
<tr><td>rsa msg decryption</td><td>☑</td><td>☑</td><td>☑</td><td>☑</td><td></td><td></td><td>☑</td></tr>
<tr><td>wasm sha256 computation</td><td>☑</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td>wasm invokation</td><td>☑</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td>std::file::read</td><td>☑</td><td>☑</td><td>☑</td><td></td><td>☑</td><td></td><td>☑</td></tr>
<tr><td>sgx::fs::read (aes key)</td><td>☑</td><td>☑</td><td>☑</td><td></td><td>☑</td><td></td><td>☑</td></tr>
<tr><td>aes decryption</td><td>☑</td><td>☑</td><td>☑</td><td></td><td>☑</td><td></td><td>☑</td></tr>
<tr><td>aes decryption</td><td>☑</td><td>☑</td><td>☑</td><td></td><td>☑</td><td></td><td>☑</td></tr>
<tr><td>std::file::write</td><td>☑</td><td>☑</td><td>☑</td><td></td><td>☑</td><td></td><td>☑</td></tr>
<tr><td>no_ops_ocall</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td>compose extrinsic</td><td>☑</td><td>☑</td><td></td><td></td><td></td><td></td><td>☑</td></tr>
<tr><td><strong>invokations/s</strong></td><td>332</td><td>342</td><td>365</td><td>400</td><td>5000</td><td>8196</td><td>4587</td></tr>
</tbody></table>
<ul>
<li><strong>call_counter</strong> represents the operations that are performed in a milestone 1 counter state update.</li>
<li><strong>call_counter_wasm</strong> represents the operations that are performed in a milestone 2 counter state update.</li>
<li><strong>sgx::fs::read:</strong> an SGX call that accesses the sealed enclave storage which is only readable by one specific enclave instance.</li>
<li><strong>ecall</strong> general entry point from the host system to an enclave.</li>
<li><strong>no_ops_ocall:</strong> an ocall (a call from the enclave to the host) that does nothing in order to see the impact of an ocall itself.</li>
<li><strong>invokations/s:</strong> stands for the number of executions per seconds that can be achieved. This does roughly correspond to tx/s.</li>
</ul>
<h2><a class="header" href="#analysis" id="analysis">Analysis</a></h2>
<ul>
<li>RSA decryption is by far the most expensive step in the whole pipeline. This, however, is hard to migitate as long as no more efficient asymmetric encryption exists.</li>
<li>The effect of sgx::fs::read does only have a small impact.</li>
<li>wasm invokation's impact is negligible</li>
<li>If the current RSA de/-encryption process is optimized, &gt;1000 tx/s, is achievable.</li>
</ul>
<h2><a class="header" href="#testsetup" id="testsetup">Testsetup</a></h2>
<p>All tests have been performend on an Intel NUC NUC8i3BEH2, Bean Canyon i3-8109U 3.0 GHz.</p>
<h1><a class="header" href="#howto" id="howto">Howto</a></h1>
<h1><a class="header" href="#m5-private-tx-demo" id="m5-private-tx-demo">M5 Private-tx demo</a></h1>
<h2><a class="header" href="#with-docker-on-any-hardware" id="with-docker-on-any-hardware">with docker on any hardware</a></h2>
<pre><code>./M5.sh
</code></pre>
<h2><a class="header" href="#on-sgx-hardware" id="on-sgx-hardware">on SGX hardware</a></h2>
<p>To run a demo for private tokens (without docker containers) do the following:</p>
<p>Assumptions:</p>
<ul>
<li>your machine has SGX support</li>
<li>Intel SGX SDK installed.</li>
<li>rust toolchain is ready to build substrate</li>
</ul>
<p>in terminal 1 run a substraTEE-node</p>
<pre><code>git clone https://github.com/scs/substraTEE-node
cd substraTEE-node
git checkout tags/M5.2
cargo build --release
./target/release/substratee-node --dev --ws-port 9979 --rpc-port 9969
</code></pre>
<p>in terminal 2, run the worker</p>
<pre><code>git clone https://github.com/scs/substraTEE-worker
cd substraTEE-worker
git checkout tags/M5.2
make
cd bin
RUST_LOG=info ./substratee_worker -p 9979 worker
</code></pre>
<p>in terminal 3, run the client</p>
<pre><code>cd substraTEE-worker/bin
./substratee_client --node-ws-port 9979
</code></pre>
<p>Then you should see this in terminal 3:</p>
<pre><code>*** Getting the amount of the registered workers
[&lt;] Found 1  workers

[&gt;] Getting the first worker's from the substraTEE-node
[&lt;] Got first worker's coordinates:
    W1's public key : &quot;5Gkzji8EtE1hTjVzTmZXWqrs6sqcHcbCooGqVH7iRRuxdnar&quot;
    W1's url: &quot;127.0.0.1:2000&quot;

[&gt;] Get the shielding key from W1 (=5Gkzji8EtE1hTjVzTmZXWqrs6sqcHcbCooGqVH7iRRuxdnar)
[&lt;] Got worker shielding key Rsa3072KeyPair: { n:CF67550FB00AB959A76219EA35188B360380037123FCAA77B683A791A1F980331F9D9E11D04C7F5FB3B63787F8AAB579FDFFE1DCE79A29B6ACED2628635C8463965D5D839BD58072AA77B8CAE124E40562955FE9936DAE2976CD57B41A2DE89EEDBF9DA77C155365E8BB45DCA1E0EC3B32604D9489712762BE63B3D1F04801D796887F70115BFDD440450A04BFE81DEE7BE718F56F766E6B0C2D9DE270583C4DFBA64FD59B4DE39C07977F1FD2956588DDBF73987EECB5BB303AF2115C4E72879C5EC69B7CD5C00DAEF9F9B062B40ADA16984C574246C8AB882A79D2E1C2F597C1017FBA69D7449BAD85ADE822D92A775DB1766F21C886E762C3E260390B72C82515F1D48FD190059B419C639E3688BCC2070E9CDB6BDDD49202B7296EA2AB01EA2D3AC2990C5078446582A4C03194BBF8D7E557B4503FF4645C053D7288398C79781F642F3A8D399195E6D2E6F74B434791D881BC97BAA0F0B228BD031C40E357BC61644E68CC40F3E08BDCBBD92E306FA9353FAEA05FDCBFCF4729FECC008C, e:01000001 }

[+] Alice's Incognito Pubkey: 5Dt1Wg85pXGLstt36t6TDdvXXoCtG6zkUL17KkyVaPYSrzGH

[+] Bob's Incognito Pubkey: 5GTTq4EnvMk4oTXYJp2kqTd2T9hbnARuee5awLiKFKsxWgRy

[+] pre-funding Alice's Incognito account (ROOT call)
[+] Subscribed, waiting for event...

[+] Received confirm call from 5Gkzji8EtE1hTjVzTmZXWqrs6sqcHcbCooGqVH7iRRuxdnar
[+] query Alice's Incognito account balance
    got getter response from worker: Ok(&quot;State is 1000000&quot;)
[+] query Bob's Incognito account balance
    got getter response from worker: Ok(&quot;State is 0&quot;)

*** incognito transfer from Alice to Bob

[+] Subscribed, waiting for event...

[+] Received confirm call from 5Gkzji8EtE1hTjVzTmZXWqrs6sqcHcbCooGqVH7iRRuxdnar
[+] query Alice's Incognito account balance
    got getter response from worker: Ok(&quot;State is 900000&quot;)
[+] query Bob's Incognito account balance
    got getter response from worker: Ok(&quot;State is 100000&quot;)

</code></pre>
<h3><a class="header" href="#so-what-happens-here" id="so-what-happens-here">So, what happens here?</a></h3>
<p>Alice wants to transfer 100k tokens privately to Bob. She doesn't use her substraTEE-node account for this as the transfer would be publicly visible.</p>
<p>Instead, she creates an <em>incognito</em> account and she keeps her account secret (also the public key). This account will never hit the substraTEE-node blockchain transparently.</p>
<p>The <em>Demo God</em> then gives Alice some initial Balance of 1M.</p>
<p>Bob also creates an <em>incognito</em> account and tells Alice (and only her) his public key.</p>
<p>Alice now uses SubstraTEE's <em>shielded transaction</em> feature to send 100k to Bob.</p>
<h3><a class="header" href="#under-the-hood" id="under-the-hood">under the hood</a></h3>
<p>TODO:</p>
<ul>
<li>block diagram</li>
<li>sequence diagram</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
